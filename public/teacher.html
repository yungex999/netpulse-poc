<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>Teacher Dashboard — NetPulse</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<link rel="stylesheet" href="/style.css">
</head>

<body>
  <h1>Teacher Dashboard — NetPulse</h1>

  <div id="controls">
    <button id="open">Open as Teacher</button>
    <span id="summary"></span>
  </div>

  <table id="studentsTbl">
    <thead>
      <tr><th>Student</th><th>RTT</th><th>Last seen</th></tr>
    </thead>
    <tbody></tbody>
  </table>

  <pre id="log"></pre>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    const tbl = document.querySelector('#studentsTbl tbody');
    const logEl = document.getElementById('log');
    const summary = document.getElementById('summary');

    const students = new Map();

    function fmtTime(ts){
      return new Date(ts).toLocaleTimeString();
    }

    function rttClass(rtt){
      if (rtt == null) return 'yellow';
      if (rtt < 50) return 'green';
      if (rtt < 150) return 'yellow';
      return 'red';
    }

    function updateTable(){
      tbl.innerHTML = '';
      const list = Array.from(students.entries())
        .sort((a,b)=> (b[1].ts||0) - (a[1].ts||0));

      for (const [id, s] of list){
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${s.name}</td>
          <td>${s.rtt}</td>
          <td>${fmtTime(s.ts)}</td>
        `;
        tbl.appendChild(tr);
      }

      summary.textContent = `Students: ${students.size}`;
    }

    function log(msg){
      logEl.textContent = msg + '\n' + logEl.textContent;
    }

    document.getElementById('open').onclick = () => {
      socket.emit('join',{role:'teacher', name:'teacher1'});
    };

    socket.on('student-join', d => {
      students.set(d.id, {name: d.name, rtt: null, ts: Date.now()});
      updateTable();
    });

    socket.on('telemetry', d => {
      const s = students.get(d.id) || {};
      s.name = d.name;
      s.rtt = d.rtt;
      s.ts = d.ts;
      students.set(d.id, s);
      updateTable();
    });

    socket.on('student-leave', d => {
      students.delete(d.id);
      updateTable();
    });
  </script>
</body>
</html>